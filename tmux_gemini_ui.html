<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Gemini Sessions</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
        }
        #list {
            width: 35%;
            border-right: 1px solid #ccc;
            overflow-y: auto;
            padding: 10px;
        }
        #log {
            flex: 1;
            padding: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            background: #111;
            color: #0f0;
            overflow-y: auto;
            height: 0; /* This forces flex item to respect container height */
            border-left: 1px solid #333;
        }
        
        /* Custom scrollbar styling for the log area */
        #log::-webkit-scrollbar {
            width: 8px;
        }
        
        #log::-webkit-scrollbar-track {
            background: #222;
        }
        
        #log::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }
        
        #log::-webkit-scrollbar-thumb:hover {
            background: #777;
        }
        .session {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .session:hover {
            background: #f0f0f0;
        }
        .error {
            color: red;
            padding: 10px;
        }
        .session-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stop-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .stop-btn:hover {
            background: #cc0000;
        }
        .attach-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 5px;
        }
        .attach-btn:hover {
            background: #1976D2;
        }
        .button-group {
            display: flex;
            gap: 5px;
        }
        .status-running {
            color: #4CAF50;
        }
        .status-done {
            color: #2196F3;
        }
        .status-stopped {
            color: #FF9800;
        }
        .status-spawning {
            color: #9C27B0;
        }
        .status-requires_user_input {
            color: #E91E63;
            font-weight: bold;
        }
        .session-prompt {
            font-size: 11px;
            color: #666;
            margin-top: 4px;
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.3;
            max-height: 3.9em;
            overflow: hidden;
        }
        .header {
            background: #333;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }
        .controls {
            padding: 10px;
            border-bottom: 1px solid #ccc;
        }
        .create-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        }
        .create-btn:hover {
            background: #45a049;
        }
        #create-form {
            display: none;
            padding: 10px;
            background: #f5f5f5;
            border-bottom: 1px solid #ccc;
        }
        #create-form input, #create-form textarea {
            width: 100%;
            margin-bottom: 10px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .form-buttons {
            display: flex;
            gap: 10px;
        }
        .form-buttons button {
            flex: 1;
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .submit-btn {
            background: #4CAF50;
            color: white;
        }
        .cancel-btn {
            background: #f44336;
            color: white;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            max-height: 80%;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        .options-display {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            margin-bottom: 15px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }
        
        .input-section {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .input-section input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .send-response-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .send-response-btn:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    <div style="width: 35%; display: flex; flex-direction: column;">
        <div class="header">üöÄ Gemini Session Manager</div>
        <div class="controls">
            <button class="create-btn" onclick="toggleCreateForm()">Create New Session</button>
            <button class="create-btn" onclick="runTestSessions()" style="background: #FF9800; margin-top: 10px;">Run Test Sessions</button>
        </div>
        <div id="create-form">
            <textarea id="prompt-input" placeholder="Enter your prompt..." rows="3">What time is it?</textarea>
            <input id="repo-input" placeholder="Repository URL (optional)" />
            <div class="form-buttons">
                <button class="submit-btn" onclick="createSession()">Create</button>
                <button class="cancel-btn" onclick="toggleCreateForm()">Cancel</button>
            </div>
        </div>
        <div id="list" style="flex: 1; overflow-y: auto;">Loading sessions...</div>
    </div>
    <div id="log" style="height: 100%;">Select a session to view logs</div>
    
    <!-- Input Options Modal -->
    <div id="optionsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Gemini is waiting for your input</h3>
                <span class="close">&times;</span>
            </div>
            <div id="optionsDisplay" class="options-display"></div>
            <div class="input-section">
                <input type="text" id="responseInput" placeholder="Enter your choice (e.g., 1, 2, 3, or y/n)">
                <button class="send-response-btn" onclick="sendResponseFromModal()">Send Response</button>
            </div>
        </div>
    </div>
    
    <script>
        async function getSessions() {
            try {
                const response = await fetch('/api/sessions');
                const data = await response.json();
                return data.sessions;
            } catch (error) {
                console.error('Error fetching sessions:', error);
                return [];
            }
        }
        
        function getStatusClass(status) {
            return `status-${status.toLowerCase()}`;
        }
        
        function formatDuration(seconds) {
            if (!seconds) return '';
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}m ${secs}s`;
        }
        
        function render(list) {
            const ul = document.getElementById('list');
            if (!list || list.length === 0) {
                ul.innerHTML = '<div class="error">No sessions found</div>';
                return;
            }
            
            // Separate sessions by status
            const userInputSessions = list.filter(s => s.status === 'REQUIRES_USER_INPUT');
            const activeSessions = list.filter(s => s.status !== 'STOPPED' && s.status !== 'DONE' && s.status !== 'REQUIRES_USER_INPUT');
            const stoppedSessions = list.filter(s => s.status === 'STOPPED');
            const completedSessions = list.filter(s => s.status === 'DONE');
            
            ul.innerHTML = '';
            
            // User input required sessions section (most important)
            if (userInputSessions.length > 0) {
                const userInputHeader = document.createElement('div');
                userInputHeader.innerHTML = '<strong>‚ö†Ô∏è Requires User Input</strong>';
                userInputHeader.style.padding = '10px';
                userInputHeader.style.background = '#ffebee';
                userInputHeader.style.borderBottom = '1px solid #ccc';
                userInputHeader.style.color = '#E91E63';
                ul.appendChild(userInputHeader);
                
                userInputSessions.forEach(s => {
                    ul.appendChild(createSessionElement(s));
                });
            }
            
            // Active sessions section
            if (activeSessions.length > 0) {
                const activeHeader = document.createElement('div');
                activeHeader.innerHTML = '<strong>üîÑ Active Sessions</strong>';
                activeHeader.style.padding = '10px';
                activeHeader.style.background = '#f0f0f0';
                activeHeader.style.borderBottom = '1px solid #ccc';
                activeHeader.style.marginTop = userInputSessions.length > 0 ? '10px' : '0';
                ul.appendChild(activeHeader);
                
                activeSessions.forEach(s => {
                    ul.appendChild(createSessionElement(s));
                });
            }
            
            // Completed sessions section
            if (completedSessions.length > 0) {
                const completedHeader = document.createElement('div');
                completedHeader.innerHTML = '<strong>‚úÖ Completed Sessions</strong>';
                completedHeader.style.padding = '10px';
                completedHeader.style.background = '#e8f5e8';
                completedHeader.style.borderBottom = '1px solid #ccc';
                completedHeader.style.marginTop = '10px';
                ul.appendChild(completedHeader);
                
                completedSessions.forEach(s => {
                    ul.appendChild(createSessionElement(s));
                });
            }
            
            // Stopped sessions section
            if (stoppedSessions.length > 0) {
                const stoppedHeader = document.createElement('div');
                stoppedHeader.innerHTML = '<strong>üõë Stopped Sessions</strong>';
                stoppedHeader.style.padding = '10px';
                stoppedHeader.style.background = '#fff3cd';
                stoppedHeader.style.borderBottom = '1px solid #ccc';
                stoppedHeader.style.marginTop = '10px';
                ul.appendChild(stoppedHeader);
                
                stoppedSessions.forEach(s => {
                    ul.appendChild(createSessionElement(s));
                });
            }
        }
        
        function createSessionElement(s) {
            const d = document.createElement('div');
            d.className = 'session';
            
            const info = document.createElement('div');
            info.className = 'session-info';
            
            const textContainer = document.createElement('div');
            textContainer.style.flex = '1';
            textContainer.style.cursor = 'pointer';
            textContainer.onclick = () => openLog(s.session_id);
            
            const statusText = document.createElement('div');
            statusText.innerHTML = `<strong>${s.session_id}</strong> [<span class="${getStatusClass(s.status)}">${s.status}</span>]`;
            if (s.sleep_duration) {
                statusText.innerHTML += ` (${formatDuration(s.sleep_duration)})`;
            }
            
            const promptText = document.createElement('div');
            promptText.className = 'session-prompt';
            promptText.textContent = s.prompt;
            promptText.title = s.prompt; // Show full prompt on hover
            
            textContainer.appendChild(statusText);
            textContainer.appendChild(promptText);
            info.appendChild(textContainer);
            
            // Create button group for actions
            const buttonGroup = document.createElement('div');
            buttonGroup.className = 'button-group';
            
            // Add attach button for all sessions (not just running ones)
            const attachBtn = document.createElement('button');
            attachBtn.className = 'attach-btn';
            attachBtn.textContent = 'Copy Attach';
            attachBtn.title = 'Copy tmux attach command to clipboard';
            attachBtn.onclick = async (e) => {
                e.stopPropagation();
                await copyAttachCommand(s.session_id);
            };
            buttonGroup.appendChild(attachBtn);
            
            // Add input button for sessions requiring user input
            if (s.status === 'REQUIRES_USER_INPUT') {
                const inputBtn = document.createElement('button');
                inputBtn.className = 'attach-btn';
                inputBtn.style.background = '#E91E63';
                inputBtn.textContent = 'View Options';
                inputBtn.onclick = async (e) => {
                    e.stopPropagation();
                    await showInputOptions(s.session_id);
                };
                buttonGroup.appendChild(inputBtn);
            }
            
            // Add stop button for running sessions and those requiring user input
            if (s.status === 'RUNNING' || s.status === 'REQUIRES_USER_INPUT') {
                const stopBtn = document.createElement('button');
                stopBtn.className = 'stop-btn';
                stopBtn.textContent = 'Stop';
                stopBtn.onclick = async (e) => {
                    e.stopPropagation();
                    await stopSession(s.session_id);
                };
                buttonGroup.appendChild(stopBtn);
            }
            
            info.appendChild(buttonGroup);
            d.appendChild(info);
            return d;
        }
        
        async function copyAttachCommand(sessionId) {
            const command = `tmux attach-session -t gemini_manager`;
            const fullInstructions = `${command}
# Then use Ctrl+B + arrow keys to navigate to the ${sessionId} pane
# Or find the pane with: tmux list-panes -t gemini_manager -F "#{pane_id}: #{pane_title}" | grep "${sessionId}"
# Then select it with: tmux select-pane -t gemini_manager:<pane_number>`;
            
            try {
                await navigator.clipboard.writeText(fullInstructions);
                
                // Show temporary feedback
                const attachBtn = event.target;
                const originalText = attachBtn.textContent;
                attachBtn.textContent = 'Copied!';
                attachBtn.style.background = '#4CAF50';
                
                setTimeout(() => {
                    attachBtn.textContent = originalText;
                    attachBtn.style.background = '#2196F3';
                }, 1500);
                
                console.log(`Copied to clipboard: ${fullInstructions}`);
            } catch (err) {
                console.error('Failed to copy to clipboard:', err);
                
                // Fallback: show alert with command
                alert(`Copy this command:\n${fullInstructions}`);
            }
        }
        
        async function stopSession(id) {
            try {
                const response = await fetch(`/api/sessions/${id}/stop`, { method: 'POST' });
                if (response.ok) {
                    console.log(`Session ${id} stopped`);
                    // Refresh the list
                    const sessions = await getSessions();
                    render(sessions);
                } else {
                    console.error('Failed to stop session');
                }
            } catch (error) {
                console.error('Error stopping session:', error);
            }
        }
        
        let currentSessionForInput = null;
        
        async function showInputOptions(sessionId) {
            try {
                const response = await fetch(`/api/sessions/${sessionId}/options`);
                if (response.ok) {
                    const data = await response.json();
                    
                    // Display the options in the modal
                    const optionsDisplay = document.getElementById('optionsDisplay');
                    optionsDisplay.textContent = data.full_output.join('\n');
                    
                    // Store the session ID for when user sends response
                    currentSessionForInput = sessionId;
                    
                    // Show the modal
                    const modal = document.getElementById('optionsModal');
                    modal.style.display = 'block';
                    
                    // Focus on the input field
                    document.getElementById('responseInput').focus();
                } else {
                    console.error('Failed to get options:', await response.text());
                    alert('Failed to get input options');
                }
            } catch (error) {
                console.error('Error getting options:', error);
                alert('Error getting input options');
            }
        }
        
        async function sendResponseFromModal() {
            const responseInput = document.getElementById('responseInput');
            const userResponse = responseInput.value.trim();
            
            if (!userResponse) {
                alert('Please enter a response');
                return;
            }
            
            if (!currentSessionForInput) {
                alert('No session selected');
                return;
            }
            
            try {
                const response = await fetch(`/api/sessions/${currentSessionForInput}/input?response=${encodeURIComponent(userResponse)}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    console.log(`Input sent to session ${currentSessionForInput}`);
                    
                    // Close the modal
                    document.getElementById('optionsModal').style.display = 'none';
                    responseInput.value = '';
                    currentSessionForInput = null;
                    
                    // Refresh the session list
                    const sessions = await getSessions();
                    render(sessions);
                } else {
                    console.error('Failed to send input:', await response.text());
                    alert('Failed to send input');
                }
            } catch (error) {
                console.error('Error sending input:', error);
                alert('Error sending input');
            }
        }
        
        async function sendInput(sessionId, userResponse) {
            try {
                const response = await fetch(`/api/sessions/${sessionId}/input?response=${encodeURIComponent(userResponse)}`, {
                    method: 'POST'
                });
                if (response.ok) {
                    console.log(`Input sent to session ${sessionId}`);
                    // Refresh the session list
                    const sessions = await getSessions();
                    render(sessions);
                } else {
                    console.error('Failed to send input:', await response.text());
                }
            } catch (error) {
                console.error('Error sending input:', error);
            }
        }
        
        let sock;
        let currentSessionId = null;
        
        function openLog(id) {
            currentSessionId = id;
            if (sock) {
                sock.close();
            }
            document.getElementById('log').textContent = `Loading logs for ${id}...\n`;
            sock = new WebSocket(`ws://${location.host}/ws/${id}`);
            
            sock.onopen = () => {
                console.log(`WebSocket connected for session ${id}`);
            };
            
            sock.onmessage = e => {
                const logDiv = document.getElementById('log');
                logDiv.textContent += e.data + '\n';
                
                // Auto-scroll to bottom with smooth behavior
                logDiv.scrollTop = logDiv.scrollHeight;
                // Force scroll if needed
                setTimeout(() => {
                    logDiv.scrollTop = logDiv.scrollHeight;
                }, 10);
            };
            
            sock.onerror = e => {
                document.getElementById('log').textContent += '\nError connecting to WebSocket\n';
            };
            
            sock.onclose = () => {
                console.log(`WebSocket closed for session ${id}`);
            };
        }
        
        function toggleCreateForm() {
            const form = document.getElementById('create-form');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
            if (form.style.display === 'block') {
                document.getElementById('prompt-input').focus();
            }
        }
        
        async function createSession() {
            const prompt = document.getElementById('prompt-input').value.trim();
            const repo = document.getElementById('repo-input').value.trim();
            
            if (!prompt) {
                alert('Please enter a prompt');
                return;
            }
            
            try {
                const params = new URLSearchParams({ prompt });
                if (repo) params.append('repo_url', repo);
                
                const response = await fetch(`/api/sessions/create?${params}`, { method: 'POST' });
                if (response.ok) {
                    // Clear form and hide it
                    document.getElementById('prompt-input').value = '';
                    document.getElementById('repo-input').value = '';
                    toggleCreateForm();
                    
                    // Refresh the list
                    const sessions = await getSessions();
                    render(sessions);
                } else {
                    const error = await response.text();
                    alert(`Failed to create session: ${error}`);
                }
            } catch (error) {
                console.error('Error creating session:', error);
                alert('Error creating session');
            }
        }
        
        async function runTestSessions() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Creating...';
            button.disabled = true;
            
            try {
                // Test Session 1: German hello world with delays
                const session1Prompt = "Write a Python script that prints hello_world in German twice, with a 10-second sleep delay between each call";
                
                // Test Session 2: Generate Hallo multiple times
                const session2Prompt = "Write a Python script that generates the word 'Hallo' 20 times with 5 seconds between each time";
                
                console.log('Creating test session 1...');
                const response1 = await fetch('/api/sessions/create?' + new URLSearchParams({ prompt: session1Prompt }), { method: 'POST' });
                
                console.log('Creating test session 2...');
                const response2 = await fetch('/api/sessions/create?' + new URLSearchParams({ prompt: session2Prompt }), { method: 'POST' });
                
                if (response1.ok && response2.ok) {
                    console.log('Both test sessions created successfully');
                    // Refresh the list
                    const sessions = await getSessions();
                    render(sessions);
                } else {
                    console.error('Failed to create one or both test sessions');
                    alert('Failed to create test sessions');
                }
            } catch (error) {
                console.error('Error creating test sessions:', error);
                alert('Error creating test sessions');
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }
        
        // Initialize
        (async () => {
            try {
                const sessions = await getSessions();
                render(sessions);
                setInterval(async () => {
                    const sessions = await getSessions();
                    render(sessions);
                }, 3000);
            } catch (error) {
                document.getElementById('list').innerHTML = '<div class="error">Error loading sessions</div>';
            }
        })();
        
        // Modal close functionality
        const modal = document.getElementById('optionsModal');
        const closeBtn = document.querySelector('.close');
        const responseInput = document.getElementById('responseInput');
        
        // Close modal when clicking the X
        closeBtn.onclick = function() {
            modal.style.display = 'none';
            responseInput.value = '';
            currentSessionForInput = null;
        }
        
        // Close modal when clicking outside of it
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
                responseInput.value = '';
                currentSessionForInput = null;
            }
        }
        
        // Send response when pressing Enter in the input field
        responseInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                sendResponseFromModal();
            }
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const form = document.getElementById('create-form');
                if (form.style.display !== 'none') {
                    toggleCreateForm();
                } else if (modal.style.display === 'block') {
                    modal.style.display = 'none';
                    responseInput.value = '';
                    currentSessionForInput = null;
                }
            }
        });
    </script>
</body>
</html> 